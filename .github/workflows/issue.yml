name: Create, Link, and Add Issue to Project from PR

on:
  pull_request:
    types: [opened]

jobs:
  create_link_and_add:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      # PASSO ADICIONADO PARA CORRIGIR O ERRO
      - name: Update GitHub CLI to the latest version
        run: |
          sudo apt-get update
          sudo apt-get install --only-upgrade -y gh

      - name: Create Issue with Checklist
        id: create_issue 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          ISSUE_BODY: |
            Pull Request #${{ github.event.pull_request.number }} foi aberto.

            *Link para o PR:* ${{ github.event.pull_request.html_url }}

            ---

            ### Checklist de Revisão
            - [ ] O código segue os padrões do projeto?
            - [ ] A documentação foi atualizada?
            - [ ] Os testes unitários foram criados/atualizados e estão passando?
            - [ ] A funcionalidade foi testada manualmente?
        run: |
          ISSUE_OUTPUT=$(gh issue create --title "Revisão do PR: ${{ env.PR_TITLE }}" \
                                        --body "${{ env.ISSUE_BODY }}" \
                                        --label "revisão-pr" \
                                        --json number,id)
          
          ISSUE_NUMBER=$(echo $ISSUE_OUTPUT | jq --raw-output .number)
          ISSUE_ID=$(echo $ISSUE_OUTPUT | jq --raw-output .id)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT

      - name: Add Issue to Project
        uses: actions/add-to-project@v0.5.0
        with:
          # IMPORTANTE: Substitua pela URL do seu projeto!
          project-url: "https://github.com/users/gabiminas/projects/1"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          content-id: ${{ steps.create_issue.outputs.issue_id }}

      - name: Link PR to Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.issue_number }}
        run: |
          gh pr edit ${{ env.PR_NUMBER }} --body "${{ env.PR_BODY }}

          Closes #${{ env.ISSUE_NUMBER }}"