name: Create, Link, and Add Issue to Project from PR

on:
  pull_request:
    types: [opened]

jobs:
  create_link_and_add:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Issue
        id: create_issue 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }} # Login do autor do PR
          ISSUE_BODY: |
            Pull Request #${{ github.event.pull_request.number }} foi aberto.

            *Link para o PR:* ${{ github.event.pull_request.html_url }}

            ---

            ### Checklist de Revisão
            - [ ] O código segue os padrões do projeto?
            - [ ] A documentação foi atualizada?
            - [ ] Os testes unitários foram criados/atualizados e estão passando?
            - [ ] A funcionalidade foi testada manualmente?
        run: |
          # Criação da Issue
          ISSUE_URL=$(gh issue create --title "Revisão do PR: ${{ env.PR_TITLE }}" \
                                     --body "${{ env.ISSUE_BODY }}" \
                                     --label "to-project") 

          # Extrair o número da issue
          ISSUE_NUMBER=$(basename "$ISSUE_URL")
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Atribuir a issue ao autor do PR
          gh issue edit $ISSUE_NUMBER --add-assignee "${{ env.PR_AUTHOR }}"

          # Adicionar a issue ao projeto (substitua pelo ID do seu projeto)
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -d '{"content_type":"Issue","content_id":'${ISSUE_NUMBER}',"project_id":1}' \
            https://api.github.com/repos/${{ github.repository }}/projects/columns/cards

      - name: Link PR to Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.issue_number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Obter o corpo atual do PR usando a API do GitHub
          PR_BODY=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json body -q ".body")

          # Adicionar a referência à issue no final do corpo
          UPDATED_BODY="${PR_BODY}\n\nCloses #${ISSUE_NUMBER}"

          # Atualizar o corpo do PR
          gh pr edit "$PR_NUMBER" --repo "$REPO" --body "$UPDATED_BODY"

